<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin â€” Monitoreo Ãcaros</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="navbar">
        <div class="brand">ğŸŒ¿ Monitoreo <span>Ãcaros</span></div>
        <nav>
            <a href="index.html">Dashboard</a>
            <a href="exceles.html">Cargar Datos</a>
            <a href="informes.html">Informes</a>
            <a href="admin.html">Admin</a>
        </nav>
    </header>

    <div class="container">
        <div id="alertContainer"></div>

        <!-- Fincas -->
        <div class="card">
            <h2>ğŸ¡ GestiÃ³n de Fincas</h2>
            <div style="display:flex; gap:8px; margin-bottom:16px;">
                <input type="text" id="newFincaName" placeholder="Nombre de la finca" style="flex:1; padding:8px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:.9rem;">
                <button class="btn btn-primary" id="btnAddFinca">â• Agregar Finca</button>
            </div>
            <div style="overflow-x:auto;">
                <table class="data-table" id="tableFincas">
                    <thead><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Bloques -->
        <div class="card">
            <h2>ğŸ“¦ GestiÃ³n de Bloques</h2>
            <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                <select id="bloqueFinca" style="padding:8px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:.9rem; min-width:200px;">
                    <option value="">Seleccionar finca</option>
                </select>
                <input type="text" id="newBloqueName" placeholder="Nombre del bloque" style="flex:1; padding:8px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:.9rem;">
                <button class="btn btn-primary" id="btnAddBloque">â• Agregar Bloque</button>
            </div>
            <div style="overflow-x:auto;">
                <table class="data-table" id="tableBloques">
                    <thead><tr><th>ID</th><th>Finca</th><th>Bloque</th><th>Acciones</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- SQL Reference -->
        <div class="card">
            <h2>ğŸ—„ï¸ Referencia SQL para setup inicial</h2>
            <p style="margin-bottom:12px;">Ejecuta este SQL en el <strong>SQL Editor de Supabase</strong> para crear las tablas y polÃ­ticas RLS:</p>
            <pre style="background:#263238; color:#eeffff; padding:16px; border-radius:8px; overflow-x:auto; font-size:.82rem; line-height:1.6;"><code id="sqlCode"></code></pre>
            <button class="btn btn-outline" style="margin-top:8px;" onclick="copySql()">ğŸ“‹ Copiar SQL</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
    const SQL_SETUP = `-- ============================================================
-- SQL Setup â€” Sistema de Monitoreo de Ãcaros
-- Ejecutar en Supabase SQL Editor
-- ============================================================

-- 1. Tabla: fincas
CREATE TABLE IF NOT EXISTS fincas (
    id BIGSERIAL PRIMARY KEY,
    nombre TEXT NOT NULL UNIQUE
);

-- 2. Tabla: bloques
CREATE TABLE IF NOT EXISTS bloques (
    id BIGSERIAL PRIMARY KEY,
    finca_id BIGINT NOT NULL REFERENCES fincas(id) ON DELETE CASCADE,
    nombre TEXT NOT NULL,
    UNIQUE(finca_id, nombre)
);

-- 3. Tabla: monitoreos
CREATE TABLE IF NOT EXISTS monitoreos (
    id BIGSERIAL PRIMARY KEY,
    fecha DATE NOT NULL,
    finca_id BIGINT NOT NULL REFERENCES fincas(id) ON DELETE CASCADE,
    bloque_id BIGINT REFERENCES bloques(id) ON DELETE SET NULL,
    lat DOUBLE PRECISION NOT NULL,
    lon DOUBLE PRECISION NOT NULL,
    tecnico TEXT DEFAULT '',
    brotes_pos INTEGER DEFAULT 0,
    hojas_adultas_pos INTEGER DEFAULT 0,
    limones_pos INTEGER DEFAULT 0,
    botones_pos INTEGER DEFAULT 0,
    yemas_pos INTEGER DEFAULT 0,
    fingerprint TEXT NOT NULL UNIQUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. Ãndices para rendimiento
CREATE INDEX IF NOT EXISTS idx_monitoreos_fecha ON monitoreos(fecha);
CREATE INDEX IF NOT EXISTS idx_monitoreos_finca ON monitoreos(finca_id);
CREATE INDEX IF NOT EXISTS idx_monitoreos_fingerprint ON monitoreos(fingerprint);

-- 5. Habilitar RLS
ALTER TABLE fincas ENABLE ROW LEVEL SECURITY;
ALTER TABLE bloques ENABLE ROW LEVEL SECURITY;
ALTER TABLE monitoreos ENABLE ROW LEVEL SECURITY;

-- 6. PolÃ­ticas RLS para acceso anÃ³nimo
-- Fincas: lectura pÃºblica, inserciÃ³n y actualizaciÃ³n para admin
CREATE POLICY "fincas_select_anon" ON fincas FOR SELECT TO anon USING (true);
CREATE POLICY "fincas_insert_anon" ON fincas FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "fincas_update_anon" ON fincas FOR UPDATE TO anon USING (true) WITH CHECK (true);
CREATE POLICY "fincas_delete_anon" ON fincas FOR DELETE TO anon USING (true);

-- Bloques: lectura pÃºblica, inserciÃ³n y actualizaciÃ³n
CREATE POLICY "bloques_select_anon" ON bloques FOR SELECT TO anon USING (true);
CREATE POLICY "bloques_insert_anon" ON bloques FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "bloques_update_anon" ON bloques FOR UPDATE TO anon USING (true) WITH CHECK (true);
CREATE POLICY "bloques_delete_anon" ON bloques FOR DELETE TO anon USING (true);

-- Monitoreos: lectura, inserciÃ³n y actualizaciÃ³n (para upsert)
CREATE POLICY "monitoreos_select_anon" ON monitoreos FOR SELECT TO anon USING (true);
CREATE POLICY "monitoreos_insert_anon" ON monitoreos FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "monitoreos_update_anon" ON monitoreos FOR UPDATE TO anon USING (true) WITH CHECK (true);`;

    document.getElementById('sqlCode').textContent = SQL_SETUP;

    function copySql() {
        navigator.clipboard.writeText(SQL_SETUP).then(() => {
            Utils.showAlert(document.getElementById('alertContainer'), 'SQL copiado al portapapeles âœ“', 'success');
        });
    }

    // ---- Fincas CRUD ----
    async function loadFincasTable() {
        const fincas = await loadFincas(true);
        const tbody = document.querySelector('#tableFincas tbody');
        tbody.innerHTML = fincas.map(f => `<tr>
            <td>${f.id}</td><td>${f.nombre}</td>
            <td><button class="btn btn-danger" style="padding:4px 10px; font-size:.8rem;" onclick="deleteFinca(${f.id})">ğŸ—‘ï¸</button></td>
        </tr>`).join('');

        // Update bloque dropdown
        const sel = document.getElementById('bloqueFinca');
        sel.innerHTML = '<option value="">Seleccionar finca</option>' +
            fincas.map(f => `<option value="${f.id}">${f.nombre}</option>`).join('');
    }

    document.getElementById('btnAddFinca').addEventListener('click', async () => {
        const name = document.getElementById('newFincaName').value.trim();
        if (!name) { Utils.showAlert(document.getElementById('alertContainer'), 'Ingresa el nombre de la finca', 'warning'); return; }
        const { error } = await db.from('fincas').insert({ nombre: name });
        if (error) {
            Utils.showAlert(document.getElementById('alertContainer'), 'Error: ' + error.message, 'error');
        } else {
            document.getElementById('newFincaName').value = '';
            Utils.showAlert(document.getElementById('alertContainer'), `Finca "${name}" agregada âœ“`, 'success');
            loadFincasTable();
        }
    });

    window.deleteFinca = async (id) => {
        if (!confirm('Â¿Eliminar esta finca? Se perderÃ¡n sus bloques y monitoreos asociados.')) return;
        const { error } = await db.from('fincas').delete().eq('id', id);
        if (error) Utils.showAlert(document.getElementById('alertContainer'), 'Error: ' + error.message, 'error');
        else { Utils.showAlert(document.getElementById('alertContainer'), 'Finca eliminada', 'success'); loadFincasTable(); loadBloquesTable(); }
    };

    // ---- Bloques CRUD ----
    async function loadBloquesTable() {
        const bloques = await loadAllBloques();
        const fincas = await loadFincas();
        const fincaMap = {};
        fincas.forEach(f => fincaMap[f.id] = f.nombre);

        const tbody = document.querySelector('#tableBloques tbody');
        tbody.innerHTML = bloques.map(b => `<tr>
            <td>${b.id}</td>
            <td>${fincaMap[b.finca_id] || b.finca_id}</td>
            <td>${b.nombre}</td>
            <td><button class="btn btn-danger" style="padding:4px 10px; font-size:.8rem;" onclick="deleteBloque(${b.id})">ğŸ—‘ï¸</button></td>
        </tr>`).join('');
    }

    document.getElementById('btnAddBloque').addEventListener('click', async () => {
        const fincaId = document.getElementById('bloqueFinca').value;
        const name = document.getElementById('newBloqueName').value.trim();
        if (!fincaId || !name) {
            Utils.showAlert(document.getElementById('alertContainer'), 'Selecciona una finca e ingresa el nombre del bloque', 'warning');
            return;
        }
        const { error } = await db.from('bloques').insert({ finca_id: parseInt(fincaId), nombre: name });
        if (error) {
            Utils.showAlert(document.getElementById('alertContainer'), 'Error: ' + error.message, 'error');
        } else {
            document.getElementById('newBloqueName').value = '';
            Utils.showAlert(document.getElementById('alertContainer'), `Bloque "${name}" agregado âœ“`, 'success');
            _bloques = null; // reset cache
            loadBloquesTable();
        }
    });

    window.deleteBloque = async (id) => {
        if (!confirm('Â¿Eliminar este bloque?')) return;
        const { error } = await db.from('bloques').delete().eq('id', id);
        if (error) Utils.showAlert(document.getElementById('alertContainer'), 'Error: ' + error.message, 'error');
        else { Utils.showAlert(document.getElementById('alertContainer'), 'Bloque eliminado', 'success'); _bloques = null; loadBloquesTable(); }
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadFincasTable();
        loadBloquesTable();
    });
    </script>
</body>
</html>