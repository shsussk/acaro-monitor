<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin ¬∑ Monitoreo Agr√≠cola</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }
    body { background: #f4f7fb; color: #1a2b3c; }
    nav { background: #1e3a5f; padding: 1rem 2rem; display: flex; gap: 2.5rem; }
    nav a { color: #e0e9f0; text-decoration: none; font-size: 1.2rem; font-weight: 500; padding: 0.4rem 0; border-bottom: 3px solid transparent; }
    nav a:hover { border-bottom-color: #8bc34a; color: white; }
    nav a.active { color: white; border-bottom-color: #ffb74d; }
    main { padding: 2rem; max-width: 1100px; margin: 0 auto; }
    h2 { margin-bottom: 1.2rem; font-weight: 400; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem; }
    .card { background: white; border-radius: 24px; padding: 1.5rem; box-shadow: 0 8px 20px rgba(0,0,0,0.04); }
    .card h3 { margin-bottom: 1rem; color: #1e3a5f; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 700; margin-bottom: 0.35rem; font-size: 0.9rem; }
    .form-group input, .form-group select {
      width: 100%; padding: 0.6rem 1rem; border: 1px solid #cbd5e0; border-radius: 40px; background:#f9fcff;
    }
    .btn { background: #1e3a5f; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 40px; font-weight: 700; cursor: pointer; margin-right: 0.5rem; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-outline { background: white; color: #1e3a5f; border: 2px solid #1e3a5f; }
    .btn-danger { background: #b22222; }
    .btn-danger:hover { background: #8b1a1a; }
    .btn-small { padding: 0.35rem 0.9rem; font-size: 0.9rem; }
    .row { display:flex; gap: .6rem; flex-wrap: wrap; align-items:center; }
    .message { padding: 0.8rem 1rem; border-radius: 16px; margin: 0.8rem 0; background: #eef5ff; border: 1px solid #d4e3fd; }
    .message.error { background:#fff1f1; border-color:#ffd1d1; color:#7a1f1f; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.8rem; }
    th { text-align: left; font-weight: 800; color: #1e3a5f; font-size: 0.75rem; text-transform: uppercase; padding: 0.6rem 0.2rem; background:#f0f6fd; position: sticky; top: 0; }
    td { padding: 0.6rem 0.2rem; border-bottom: 1px solid #e9eef2; }
    .scroll { max-height: 360px; overflow:auto; border-radius: 14px; border: 1px solid #e9eef2; }
    footer { margin-top: 2.5rem; text-align: center; color: #6f8a9f; }
    .muted { color:#4a5f73; font-size:.9rem; }
  </style>
</head>

<body>
  <nav>
    <a href="index.html">üåç Dashboard</a>
    <a href="informes.html">üìà Informes</a>
    <a href="exceles.html">üìé Cargar CSV</a>
    <a href="admin.html" class="active">‚öôÔ∏è Admin</a>
  </nav>

  <main>
    <h2>‚öôÔ∏è Administraci√≥n (segura)</h2>
    <p class="muted">Aqu√≠ solo entran usuarios admin (con Auth). Si no eres admin, no podr√°s insertar/editar/borrar.</p>

    <div class="card" style="margin-top:1rem;">
      <h3>üîê Acceso</h3>
      <div class="admin-grid" style="grid-template-columns: 1fr 1fr;">
        <div>
          <div class="form-group">
            <label>Email</label>
            <input id="email" type="email" placeholder="tu@email.com">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div class="row">
            <button class="btn" id="btnLogin">Entrar</button>
            <button class="btn btn-outline" id="btnLogout">Salir</button>
          </div>
        </div>
        <div>
          <div class="message" id="authBox">Estado: ‚Äî</div>
          <div class="message" id="adminBox">Admin: ‚Äî</div>
        </div>
      </div>
    </div>

    <div class="admin-grid" style="margin-top:1.5rem;">
      <div class="card">
        <h3>üè° Fincas</h3>
        <div class="form-group">
          <label>Nueva finca</label>
          <input type="text" id="nuevaFinca" placeholder="Nombre de la finca">
        </div>
        <div class="row">
          <button class="btn" id="btnAgregarFinca">Agregar</button>
          <button class="btn btn-outline" id="btnReloadFincas">Refrescar</button>
        </div>
        <div class="message" id="fincaMessage">‚Äî</div>
        <div class="scroll">
          <table>
            <thead><tr><th>Nombre</th><th>Acciones</th></tr></thead>
            <tbody id="tablaFincasBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>üß± Bloques</h3>
        <div class="form-group">
          <label>Finca</label>
          <select id="selectFincaBloque"></select>
        </div>
        <div class="form-group">
          <label>Nuevo bloque</label>
          <input type="text" id="nuevoBloque" placeholder="Ej: Bloque 1">
        </div>
        <div class="row">
          <button class="btn" id="btnAgregarBloque">Agregar bloque</button>
          <button class="btn btn-outline" id="btnReloadBloques">Refrescar</button>
        </div>
        <div class="message" id="bloqueMessage">‚Äî</div>
        <div class="scroll">
          <table>
            <thead><tr><th>Finca</th><th>Bloque</th><th>Acciones</th></tr></thead>
            <tbody id="tablaBloquesBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <footer>¬© monitoreo √°caros</footer>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'; // createClient [web:71]

    const SUPABASE_URL = 'https://ossugwjyowdinerfnyam.supabase.co';
    const SUPABASE_ANON_KEY = 'PEGA_TU_ANON_KEY_AQUI';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const authBox = document.getElementById('authBox');
    const adminBox = document.getElementById('adminBox');

    const nuevaFincaInput = document.getElementById('nuevaFinca');
    const btnAgregarFinca = document.getElementById('btnAgregarFinca');
    const btnReloadFincas = document.getElementById('btnReloadFincas');
    const fincaMsg = document.getElementById('fincaMessage');
    const tablaFincasBody = document.getElementById('tablaFincasBody');

    const selectFinca = document.getElementById('selectFincaBloque');
    const nuevoBloqueInput = document.getElementById('nuevoBloque');
    const btnAgregarBloque = document.getElementById('btnAgregarBloque');
    const btnReloadBloques = document.getElementById('btnReloadBloques');
    const bloqueMsg = document.getElementById('bloqueMessage');
    const tablaBloquesBody = document.getElementById('tablaBloquesBody');

    // Estado
    let isAdmin = false;

    function msg(el, text, isError=false) {
      el.textContent = text;
      el.classList.toggle('error', !!isError);
    }

    async function refreshSessionUI() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        msg(authBox, 'Estado: no autenticado');
        msg(adminBox, 'Admin: no');
        isAdmin = false;
        setAdminControlsEnabled(false);
        return;
      }
      msg(authBox, `Estado: autenticado (${session.user.email})`);

      // Verifica admin leyendo public.admins (RLS: solo ve su propia fila si existe)
      const { data, error } = await supabase.from('admins').select('user_id').limit(1);
      if (error) {
        msg(adminBox, 'Admin: no (sin permiso o policies faltan)', true);
        isAdmin = false;
        setAdminControlsEnabled(false);
        return;
      }
      isAdmin = (data && data.length === 1);
      msg(adminBox, `Admin: ${isAdmin ? 's√≠' : 'no'}`);
      setAdminControlsEnabled(isAdmin);
    }

    function setAdminControlsEnabled(enabled) {
      btnAgregarFinca.disabled = !enabled;
      btnAgregarBloque.disabled = !enabled;
      btnReloadFincas.disabled = false;
      btnReloadBloques.disabled = false;
      nuevaFincaInput.disabled = !enabled;
      nuevoBloqueInput.disabled = !enabled;
      selectFinca.disabled = !enabled;
    }

    // DATA
    async function cargarFincas() {
      const { data, error } = await supabase.from('fincas').select('*').order('nombre');
      if (error) { msg(fincaMsg, 'Error cargando fincas: ' + error.message, true); return []; }
      msg(fincaMsg, `Fincas cargadas: ${data?.length || 0}`);
      return data || [];
    }

    async function cargarBloques() {
      // join: bloques + fincas(nombre)
      const { data, error } = await supabase.from('bloques').select('id, nombre, finca_id, fincas(nombre)').order('finca_id');
      if (error) { msg(bloqueMsg, 'Error cargando bloques: ' + error.message, true); return []; }
      msg(bloqueMsg, `Bloques cargados: ${data?.length || 0}`);
      return data || [];
    }

    function renderSelectFincas(fincas) {
      let options = '<option value="">Seleccione finca</option>';
      for (const f of fincas) options += `<option value="${f.id}">${f.nombre}</option>`;
      selectFinca.innerHTML = options;
    }

    function renderFincasTable(fincas) {
      let html = '';
      for (const f of fincas) {
        html += `<tr>
          <td>${f.nombre}</td>
          <td>
            <button class="btn btn-small btn-outline" data-edit-finca="${f.id}" data-name="${encodeURIComponent(f.nombre)}">Renombrar</button>
            <button class="btn btn-small btn-danger" data-del-finca="${f.id}">Eliminar</button>
          </td>
        </tr>`;
      }
      tablaFincasBody.innerHTML = html;
    }

    function renderBloquesTable(bloques) {
      let html = '';
      for (const b of bloques) {
        const nombreFinca = b.fincas?.nombre || `Finca ${b.finca_id}`;
        html += `<tr>
          <td>${nombreFinca}</td>
          <td>${b.nombre}</td>
          <td>
            <button class="btn btn-small btn-outline" data-edit-bloque="${b.id}" data-name="${encodeURIComponent(b.nombre)}">Renombrar</button>
            <button class="btn btn-small btn-danger" data-del-bloque="${b.id}">Eliminar</button>
          </td>
        </tr>`;
      }
      tablaBloquesBody.innerHTML = html;
    }

    async function reloadAll() {
      const fincas = await cargarFincas();
      renderSelectFincas(fincas);
      renderFincasTable(fincas);

      const bloques = await cargarBloques();
      renderBloquesTable(bloques);
    }

    // AUTH
    btnLogin.addEventListener('click', async () => {
      msg(authBox, 'Entrando...');
      const { error } = await supabase.auth.signInWithPassword({
        email: email.value.trim(),
        password: password.value
      });
      if (error) msg(authBox, 'Login error: ' + error.message, true);
      await refreshSessionUI();
      await reloadAll();
    });

    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut();
      await refreshSessionUI();
      await reloadAll();
    });

    supabase.auth.onAuthStateChange(async () => {
      await refreshSessionUI();
      await reloadAll();
    });

    // FINCAS CRUD
    btnAgregarFinca.addEventListener('click', async () => {
      const nombre = nuevaFincaInput.value.trim();
      if (!nombre) return msg(fincaMsg, 'Escribe un nombre.', true);
      const { error } = await supabase.from('fincas').insert({ nombre });
      if (error) return msg(fincaMsg, 'Error: ' + error.message, true);
      nuevaFincaInput.value = '';
      msg(fincaMsg, 'Finca agregada.');
      await reloadAll();
    });

    btnReloadFincas.addEventListener('click', reloadAll);

    tablaFincasBody.addEventListener('click', async (e) => {
      const delId = e.target?.getAttribute?.('data-del-finca');
      const editId = e.target?.getAttribute?.('data-edit-finca');

      if (delId) {
        if (!isAdmin) return msg(fincaMsg, 'No autorizado.', true);
        if (!confirm('¬øEliminar esta finca? Tambi√©n se eliminar√°n sus bloques asociados.')) return;
        // delete() con filtro siempre [web:145]
        const { error } = await supabase.from('fincas').delete().eq('id', Number(delId));
        if (error) return msg(fincaMsg, 'Error: ' + error.message, true);
        msg(fincaMsg, 'Finca eliminada.');
        await reloadAll();
      }

      if (editId) {
        if (!isAdmin) return msg(fincaMsg, 'No autorizado.', true);
        const oldName = decodeURIComponent(e.target.getAttribute('data-name') || '');
        const nuevo = prompt('Nuevo nombre de finca:', oldName);
        if (!nuevo) return;
        const { error } = await supabase.from('fincas').update({ nombre: nuevo.trim() }).eq('id', Number(editId));
        if (error) return msg(fincaMsg, 'Error: ' + error.message, true);
        msg(fincaMsg, 'Finca actualizada.');
        await reloadAll();
      }
    });

    // BLOQUES CRUD
    btnAgregarBloque.addEventListener('click', async () => {
      if (!isAdmin) return msg(bloqueMsg, 'No autorizado.', true);
      const fincaId = selectFinca.value ? Number(selectFinca.value) : null;
      const nombre = nuevoBloqueInput.value.trim();
      if (!fincaId) return msg(bloqueMsg, 'Selecciona finca.', true);
      if (!nombre) return msg(bloqueMsg, 'Escribe nombre del bloque.', true);

      const { error } = await supabase.from('bloques').insert({ finca_id: fincaId, nombre });
      if (error) return msg(bloqueMsg, 'Error: ' + error.message, true);

      nuevoBloqueInput.value = '';
      msg(bloqueMsg, 'Bloque agregado.');
      await reloadAll();
    });

    btnReloadBloques.addEventListener('click', reloadAll);

    tablaBloquesBody.addEventListener('click', async (e) => {
      const delId = e.target?.getAttribute?.('data-del-bloque');
      const editId = e.target?.getAttribute?.('data-edit-bloque');

      if (delId) {
        if (!isAdmin) return msg(bloqueMsg, 'No autorizado.', true);
        if (!confirm('¬øEliminar este bloque?')) return;
        const { error } = await supabase.from('bloques').delete().eq('id', Number(delId)); // delete con filtro [web:145]
        if (error) return msg(bloqueMsg, 'Error: ' + error.message, true);
        msg(bloqueMsg, 'Bloque eliminado.');
        await reloadAll();
      }

      if (editId) {
        if (!isAdmin) return msg(bloqueMsg, 'No autorizado.', true);
        const oldName = decodeURIComponent(e.target.getAttribute('data-name') || '');
        const nuevo = prompt('Nuevo nombre de bloque:', oldName);
        if (!nuevo) return;
        const { error } = await supabase.from('bloques').update({ nombre: nuevo.trim() }).eq('id', Number(editId));
        if (error) return msg(bloqueMsg, 'Error: ' + error.message, true);
        msg(bloqueMsg, 'Bloque actualizado.');
        await reloadAll();
      }
    });

    // INIT
    await refreshSessionUI();
    await reloadAll();
  </script>
</body>
</html>
