<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informes ‚Äî Monitoreo √Åcaros</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="navbar">
        <div class="brand">üåø Monitoreo <span>√Åcaros</span></div>
        <nav>
            <a href="index.html">Dashboard</a>
            <a href="exceles.html">Cargar Datos</a>
            <a href="informes.html">Informes</a>
            <a href="admin.html">Admin</a>
        </nav>
    </header>

    <div class="container">
        <!-- Filtros -->
        <div class="card">
            <div class="filters">
                <div class="filter-group">
                    <label>Periodo</label>
                    <select id="filterPreset">
                        <option value="week">√öltima semana</option>
                        <option value="month" selected>√öltimo mes</option>
                        <option value="all">Todo</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
                <div class="filter-group" id="customDates" style="display:none; gap:8px;">
                    <label>Desde</label>
                    <input type="date" id="filterFrom">
                    <label>Hasta</label>
                    <input type="date" id="filterTo">
                </div>
                <div class="filter-group">
                    <label>Finca</label>
                    <select id="filterFinca"><option value="">Todas</option></select>
                </div>
                <div class="filter-group">
                    <label>Bloque</label>
                    <select id="filterBloque"><option value="">Todos</option></select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" id="btnUpdate">üìä Generar Informe</button>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-accent" id="btnExportCSV">üì• Exportar CSV</button>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-value" id="kpiTotal">‚Äî</div>
                <div class="kpi-label">Total Registros</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpiSevAvg">‚Äî</div>
                <div class="kpi-label">Severidad Prom (%)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpiSevMax">‚Äî</div>
                <div class="kpi-label">Severidad M√°x (%)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpiFincas">‚Äî</div>
                <div class="kpi-label">Fincas Evaluadas</div>
            </div>
        </div>

        <!-- Severidad por Finca -->
        <div class="card">
            <h2>üè° Severidad por Finca</h2>
            <div style="overflow-x:auto;">
                <table class="data-table" id="tableFincas">
                    <thead><tr><th>Finca</th><th>Registros</th><th>Sev. Promedio</th><th>Sev. M√°xima</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Top 5 severos -->
        <div class="card">
            <h2>üî• Top 5 Puntos M√°s Severos</h2>
            <div style="overflow-x:auto;">
                <table class="data-table" id="tableTop5">
                    <thead><tr><th>Fecha</th><th>Finca</th><th>Bloque</th><th>Lat</th><th>Lon</th><th>Severidad</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Tendencia -->
        <div class="card">
            <h2>üìà Tendencia de Severidad por D√≠a</h2>
            <div class="chart-container">
                <canvas id="chartTrend"></canvas>
            </div>
        </div>

        <!-- Severidad por Bloque -->
        <div class="card">
            <h2>üì¶ Severidad por Bloque</h2>
            <div class="chart-container">
                <canvas id="chartBloques"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
    let allData = [];
    let trendChart = null;
    let bloquesChart = null;

    function updateKPIs(data) {
        document.getElementById('kpiTotal').textContent = data.length;
        if (!data.length) {
            ['kpiSevAvg','kpiSevMax','kpiFincas'].forEach(id => document.getElementById(id).textContent = '‚Äî');
            return;
        }
        const sevs = data.map(r => Utils.calcSeveridad(r));
        document.getElementById('kpiSevAvg').textContent = (sevs.reduce((a,b)=>a+b,0)/sevs.length).toFixed(1) + '%';
        document.getElementById('kpiSevMax').textContent = Math.max(...sevs).toFixed(1) + '%';
        document.getElementById('kpiFincas').textContent = new Set(data.map(r => r.finca_id)).size;
    }

    function renderFincaTable(data) {
        const groups = {};
        data.forEach(r => {
            const name = r.fincas?.nombre || 'N/A';
            if (!groups[name]) groups[name] = [];
            groups[name].push(Utils.calcSeveridad(r));
        });
        const tbody = document.querySelector('#tableFincas tbody');
        tbody.innerHTML = Object.entries(groups)
            .sort((a,b) => {
                const avgA = a[1].reduce((x,y)=>x+y,0)/a[1].length;
                const avgB = b[1].reduce((x,y)=>x+y,0)/b[1].length;
                return avgB - avgA;
            })
            .map(([name, sevs]) => {
                const avg = (sevs.reduce((a,b)=>a+b,0)/sevs.length).toFixed(1);
                const max = Math.max(...sevs).toFixed(1);
                return `<tr>
                    <td>${name}</td><td>${sevs.length}</td>
                    <td class="${Utils.sevClass(+avg)}">${avg}%</td>
                    <td class="${Utils.sevClass(+max)}">${max}%</td>
                </tr>`;
            }).join('');
    }

    function renderTop5(data) {
        const sorted = data.map(r => ({...r, sev: Utils.calcSeveridad(r)}))
            .sort((a,b) => b.sev - a.sev).slice(0, 5);
        const tbody = document.querySelector('#tableTop5 tbody');
        tbody.innerHTML = sorted.map(r => `<tr>
            <td>${r.fecha}</td>
            <td>${r.fincas?.nombre || 'N/A'}</td>
            <td>${r.bloques?.nombre || '‚Äî'}</td>
            <td>${r.lat?.toFixed(5)}</td>
            <td>${r.lon?.toFixed(5)}</td>
            <td class="${Utils.sevClass(r.sev)}">${r.sev.toFixed(1)}%</td>
        </tr>`).join('');
    }

    function renderTrendChart(data) {
        const daily = {};
        data.forEach(r => {
            if (!daily[r.fecha]) daily[r.fecha] = [];
            daily[r.fecha].push(Utils.calcSeveridad(r));
        });
        const labels = Object.keys(daily).sort();
        const values = labels.map(d => {
            const arr = daily[d];
            return +(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1);
        });

        if (trendChart) trendChart.destroy();
        trendChart = new Chart(document.getElementById('chartTrend'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Severidad Promedio (%)',
                    data: values,
                    borderColor: '#2e7d32',
                    backgroundColor: 'rgba(46,125,50,.1)',
                    fill: true, tension: 0.3,
                    pointRadius: 3, pointBackgroundColor: '#2e7d32'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Severidad (%)' } },
                    x: { title: { display: true, text: 'Fecha' } }
                }
            }
        });
    }

    function renderBloquesChart(data) {
        const groups = {};
        data.forEach(r => {
            const name = r.bloques?.nombre || 'Sin bloque';
            if (!groups[name]) groups[name] = [];
            groups[name].push(Utils.calcSeveridad(r));
        });
        const entries = Object.entries(groups).sort((a,b) => {
            const avgA = a[1].reduce((x,y)=>x+y,0)/a[1].length;
            const avgB = b[1].reduce((x,y)=>x+y,0)/b[1].length;
            return avgB - avgA;
        }).slice(0, 20);

        const labels = entries.map(e => e[0]);
        const values = entries.map(e => +(e[1].reduce((a,b)=>a+b,0)/e[1].length).toFixed(1));
        const colors = values.map(v => Utils.sevColor(v));

        if (bloquesChart) bloquesChart.destroy();
        bloquesChart = new Chart(document.getElementById('chartBloques'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Severidad Promedio (%)',
                    data: values,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, max: 100, title: { display: true, text: 'Severidad (%)' } }
                }
            }
        });
    }

    // Export CSV
    function exportCSV(data) {
        const rows = data.map(r => ({
            Fecha: r.fecha,
            Finca: r.fincas?.nombre || '',
            Bloque: r.bloques?.nombre || '',
            Lat: r.lat, Lon: r.lon,
            Tecnico: r.tecnico || '',
            Brotes: r.brotes_pos, Hojas: r.hojas_adultas_pos,
            Limones: r.limones_pos, Botones: r.botones_pos,
            Yemas: r.yemas_pos,
            Severidad: Utils.calcSeveridad(r).toFixed(1)
        }));
        const headers = Object.keys(rows[0] || {});
        const csv = [headers.join(','),
            ...rows.map(r => headers.map(h => `"${r[h] ?? ''}"`).join(','))
        ].join('\n');
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `informe_acaros_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }

    async function refresh() {
        const btn = document.getElementById('btnUpdate');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Generando...';
        const filters = getFilterValues();
        allData = await queryMonitoreos(filters);
        updateKPIs(allData);
        renderFincaTable(allData);
        renderTop5(allData);
        renderTrendChart(allData);
        renderBloquesChart(allData);
        btn.disabled = false;
        btn.textContent = 'üìä Generar Informe';
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await populateFilters();
        document.getElementById('btnUpdate').addEventListener('click', refresh);
        document.getElementById('btnExportCSV').addEventListener('click', () => {
            if (allData.length === 0) { alert('No hay datos para exportar.'); return; }
            exportCSV(allData);
        });
        refresh();
    });
    </script>
</body>
</html>